# Copilot Instructions

## Project Overview

This project is a production-ready REST API built with **Elysia** on the **Bun** runtime. It uses **Drizzle ORM** with **PostgreSQL**, **Zod v4** for validation, and ships with auto-generated OpenAPI docs.

## Tech Stack

- **Runtime:** Bun (not Node.js) — use `bun` for all CLI commands
- **HTTP Framework:** Elysia
- **Database:** PostgreSQL via Drizzle ORM (using the `bun-sql` driver)
- **Validation:** Zod v4
- **Environment Validation:** @t3-oss/env-core + Zod
- **API Docs:** @elysiajs/openapi (served at `/docs`)
- **Type Checker:** @typescript/native-preview (`tsgo`) — NOT `tsc`
- **Formatter:** Prettier (with `prettier-plugin-organize-imports`)
- **Containerisation:** Docker with multi-stage build producing a distroless image

## Project Structure

```
src/
├── index.ts              # App entry point – boots the Elysia server
├── env.ts                # Validated env vars (Zod + t3-env)
├── data-access/          # Database query functions (one file per resource)
│   └── todo.ts
├── db/
│   ├── fields.ts         # Reusable Drizzle column definitions
│   ├── index.ts          # Drizzle client singleton
│   └── schema.ts         # All Drizzle table definitions
├── lib/
│   └── util.ts           # Shared Zod schemas (pagination, sorting)
└── routes/
    ├── index.ts           # Top-level /api router
    └── todo/
        └── index.ts       # CRUD routes for /api/todos
```

## Architecture & Conventions

### Layered Architecture

The project follows a strict separation of concerns:

1. **Routes** (`src/routes/`) — Define HTTP endpoints, request/response validation, and call data-access functions. Route handlers never import `db` directly.
2. **Data-Access** (`src/data-access/`) — All direct database interactions. One file per resource. Route handlers call these functions exclusively.
3. **Database** (`src/db/`) — Drizzle client singleton, table schema definitions, and reusable column helpers.
4. **Library** (`src/lib/`) — Shared utilities, reusable Zod schema fragments.

### Adding a New Resource

1. Create the Drizzle table in `src/db/schema.ts` (use `commonFieldDefs` from `src/db/fields.ts` for id, `createdAt`, `updatedAt`).
2. Create `src/data-access/<resource>.ts` with all DB query functions.
3. Create `src/routes/<resource>/index.ts` with the Elysia router.
4. Register the new router in `src/routes/index.ts` via `.use()`.
5. Push Schema changes with `bun run db:push`.
6. Run `bun type-check` to ensure types are correct across layers.

### Route Conventions

- All API routes live under the `/api` prefix.
- Each resource router uses `new Elysia({ prefix: '/<resource>' })`.
- Every route handler validates input using Zod schemas in the third argument to route methods (`query`, `params`, `body`).
- UUID path params are validated with `z.uuid()`.
- Each route includes a `detail` object with `description` and `tags` for OpenAPI documentation.
- Handlers use try/catch, returning `{ success: true, data: { ... } }` on success and `status(statusCode, { success: false, error: '...' })` on failure.
- Use `status()` from `elysia` (not `.set.status`) for error responses.

### Database & Schema Conventions

- All tables use **UUID** primary keys generated by the database (`defaultRandom()`).
- All tables include `created_at` and `updated_at` timestamp columns via the `commonFieldDefs.dates` spread.
- Use `commonFieldDefs.id` for the primary key column.
- The Drizzle client is a singleton exported from `src/db/index.ts`.
- Column names in the database use **snake_case** (`created_at`), while TypeScript properties use **camelCase** (`createdAt`).
- Schema definitions are in `src/db/schema.ts` — the single source of truth shared by both the app and Drizzle Kit.

### Validation & Environment

- Zod v4 is used for all request validation (NOT Elysia's built-in typebox schemas).
- Environment variables are validated at startup via `src/env.ts`. If a variable is missing or invalid the app refuses to start.
- Import env as `import { env } from '~/env'`.

### Path Aliases

- `~/*` maps to `./src/*` (configured in `tsconfig.json`). Always use `~/` imports for project files.

### Code Style

- **No semicolons** — the project uses Prettier with `semi: false`.
- **Single quotes** for strings.
- **No trailing commas** (`trailingComma: 'none'`).
- **Arrow parens:** avoid when possible (`arrowParens: 'avoid'`).
- **Tab width:** 2 spaces.
- Imports are auto-organised by `prettier-plugin-organize-imports`.
- Use `const` arrow functions for exported functions (not `function` declarations).
- Add JSDoc comments on all exports describing their purpose.

### TypeScript

- Strict mode is enabled with all strict checks (`noImplicitAny`, `strictNullChecks`, `noUnusedLocals`, `noUnusedParameters`, `noImplicitReturns`, `noUncheckedIndexedAccess`, etc.).
- Target is `ESNext` with `module: ESNext` and `moduleResolution: bundler`.
- Type checking is done with `tsgo` (`bun run type-check`), not `tsc`.

### Pagination & Sorting

- Use the `paginationSchema` spread from `src/lib/util.ts` for paginated list endpoints (offset-based, 1-indexed pages, default limit 10, max 100).
- Use `getSortSchema(['field1', 'field2', ...])` for sortable endpoints.
- List responses follow the shape: `{ success, data: { page, limit, hasMore, <items>, count } }`.

### Error Handling

- Route handlers wrap logic in try/catch.
- Log errors with `console.error('Error in METHOD /path', err)`.
- Return `status(500, { success: false, error: 'Something went wrong.' })` for unexpected errors.
- Return `status(404, { success: false, error: '<Resource> not found' })` for missing resources.

## Commands

| Command                | Purpose                               |
| ---------------------- | ------------------------------------- |
| `bun dev`              | Start dev server with hot-reload      |
| `bun run build`        | Type-check + compile to native binary |
| `bun run type-check`   | Run tsgo type checker                 |
| `bun run format`       | Format code with Prettier             |
| `bun run db:push`      | Push Drizzle schema to the database   |
| `bun run db:studio`    | Open Drizzle Studio                   |
| `bun run db:seed`      | Run seed script                       |
| `bun run build:docker` | Build Docker image                    |
